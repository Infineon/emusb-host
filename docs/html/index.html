<!-- HTML header for doxygen 1.8.13-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>emusb-host</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen_style.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><a href="http://www.cypress.com/"><img alt="Logo" src="logo.png"/></a></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">emusb-host</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('index.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">SEGGER emUSB-Host for ModusToolbox User Guide </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p ><a href="https://www.segger.com/products/connectivity/emusb-host/"><b>emUSB-Host</b></a> is a CPU-independent USB Host stack. emUSB-Host is a high-performance library that has been optimized for speed, versatility and small memory footprint. Infineon has licensed emUSB-Host from SEGGER and offers it for free to its customers. This Middleware library provides emUSB-Host in the form of pre-build libraries.</p>
<p ><b>Features:</b></p><ul>
<li>High performance</li>
<li>Small footprint</li>
<li>No configuration required</li>
<li>Control, bulk, interrupt and isochronous transfers</li>
<li>Very simple host controller driver structure</li>
<li>Support for external USB hub devices</li>
<li>Support for devices with alternate settings</li>
<li>Support for multi-interface devices</li>
<li>Support for multi-configuration devices</li>
</ul>
<p ><b>Supported USB Device Drivers/Classes:</b></p><ul>
<li>BULK Device Driver</li>
<li>CCID Device Driver</li>
<li>CDC Device Driver</li>
<li>CP210X Device Driver</li>
<li>FT232 Device Driver</li>
<li>Human Interface Devices (HID) class</li>
<li>MIDI Device Driver</li>
<li>Mass Storage Device (MSD) class</li>
<li>MTP Device Driver</li>
<li>Printer class</li>
</ul>
<p ><b>Device families supported by the Middleware:</b></p><ul>
<li>CAT1A</li>
</ul>
<h1><a class="anchor" id="section_emusb_host_general"></a>
General Description</h1>
<p >This manual provides only the basic concepts of emUSB-Host and integration specifics of the emUSB-Host into ModusToolbox flow. For a detail description of the emUSB-Host features, implementation, and APIs, refer to: <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a>.</p>
<p ><a class="el" href="index.html#section_emusb_host_quick_start">The Quick Start Guide</a> is available in this API Reference Guide.</p>
<p ><b>emUSB-Host consists of the following layers:</b></p><ul>
<li>The driver for hardware access</li>
<li>The emUSB-Host core</li>
<li>The USB class driver</li>
</ul>
<p >emUSB-Host and the USB class drivers are device-independent, while the driver for hardware access is applicable only for one device family. The driver is selected in the USBH_X_Config() function, the template of implementation of USBH_X_Config() is in the Config folder.</p>
<p >The drivers for emUSB-Host can support not all available features and may need to be configured in a special manners, refer to the: <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a> Host controller specifics chapter.</p>
<p ><b>Supported Drivers by the Device family</b></p>
<table class="doxtable">
<tr>
<th>Device family</th><th>Drivers</th><th>Function to add driver </th></tr>
<tr>
<td>CAT1A </td><td>Cypress PSoC 6 driver </td><td>USBH_Cypress_PSoC_Add()  </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>For the function description, refer to the: <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a> Host controller specifics chapter.</dd></dl>
<p>The emUSB-Host is provided in the form of pre-build libraries. The pre-build library is selected automatically based on configuration of Application project.</p>
<p >The emUSB-Host includes an OS abstraction implemented by abstraction-rtos, so this Middleware can be used with any RTOSes supported by abstraction-rtos. The RTOS is required for the emUSB-Host operation.</p>
<p >The hardware dependency files are presented in export/Config directory:</p><ul>
<li>One common file responsible for the debug message output</li>
<li>Device-specific files for the hardware configuration of each supported device family</li>
</ul>
<p >Also, the emUSB-Host/Device personality is present in the Device-configurator for simplify routine of configuration clocks and pins for USB IP block operation. The personality is a part of mtb-pdl-cat1 for CAT1A devices.</p>
<h1><a class="anchor" id="section_emusb_host_quick_start"></a>
The Quick Start Guide</h1>
<p >To set up emUSB-Host for Human Interface Devices (HID), follow the below- described steps. This code snippets will try to enumerate a connected mouse or keyboard and output data about a pressed key or mouse movements and clicks. The current snippet is based on SEGGER sample application.</p>
<h2><a class="anchor" id="subsection_qsg_step1"></a>
STEP 1: Add the emUSB-Host middleware.</h2>
<ol type="1">
<li>Launch the ModusToolbox Library Manager, click Add Library button and select the next libraries: emUSB-Host and FreeRTOS middleware. This step is required only if the ModusToolbox IDE is used. Otherwise, ensure include the emUSB-Host middleware in your project. <div class="image">
<img src="emusb_host_lib_mngr.png" alt=""/>
</div>
 <dl class="section note"><dt>Note</dt><dd>To use the terminal output, add <a href="https://infineon.github.io/retarget-io/html/index.html"><b>retarget-io middleware </b></a> from the Library Manager.</dd></dl>
</li>
<li>Open Makefile of the project. Add USBH_BASE and FREERTOS to the COMPONENTS section of the Makefile. <div class="image">
<img src="emusb_host_makefile.png" alt=""/>
</div>
</li>
</ol>
<h2><a class="anchor" id="subsection_qsg_step2"></a>
STEP 2: Configure pins and clocks for emUSB-Host.</h2>
<ol type="1">
<li>Launch the ModusToolbox Device Configurator Tool and switch to the Peripherals tab (#1.1).</li>
<li>Enable the USB personality under Communication (#1.2) and select emUSB-Host/Device 1.0 personality (#1.3).</li>
<li>Ensure that USB mode is Host (#1.4) and the Clock is connected to CLK_HF3 (#1.5). <div class="image">
<img src="emusb_host_peripherals_cfg.png" alt=""/>
</div>
</li>
<li><p class="startli">Switch to the System tab (#2.1).</p>
<dl class="section note"><dt>Note</dt><dd>The clocking system can be different between devices.</dd></dl>
</li>
<li>Enable the clock source which has the accuracy +/-0.05% (it could be ECO - case (#2.2)).</li>
<li>If your device supports more than one PLL, select one. Enable the selected PLL and set a frequency of 48 MHz (#2.3). <dl class="section note"><dt>Note</dt><dd>Select the enabled source clock with accuracy +/-0.05% into the PATH_MUX section of the selected PLL (#2.4).</dd></dl>
</li>
<li>Select the CLK_HF3 USB clock (#2.5). Assign the source clock to the CLK_PATH connected to the configured previously PLL.</li>
<li>Select File-&gt;Save to generate initialization code. <div class="image">
<img src="emusb_host_system_cfg.png" alt=""/>
</div>
</li>
<li>If the Power personality is enabled, the System Idle Power Mode option must be Active, or CPU Sleep. <div class="image">
<img src="emusb_host_power_cfg.png" alt=""/>
</div>
</li>
</ol>
<h2><a class="anchor" id="subsection_qsg_step3"></a>
STEP 3: Write the code in main.c.</h2>
<ol type="1">
<li>Include headers to get access to the emUSB drivers, retarget-io and FreeRTOS. <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cybsp.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cy_retarget_io.h&quot;</span></div>
<div class="line"><span class="comment">/* Include emUSB-Host headers */</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBH.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;USBH_HID.h&quot;</span></div>
<div class="line"><span class="comment">/* Include FreeRTOS headers */</span></div>
<div class="line"><span class="preprocessor">#include &quot;FreeRTOS.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;task.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;event_groups.h&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;cyabs_rtos.h&quot;</span></div>
</div><!-- fragment --> <dl class="section note"><dt>Note</dt><dd>Also, if you are working with PSoC 6 boards, include the following file: <div class="fragment"><div class="line"><span class="preprocessor">#include &quot;cyhal.h&quot;</span></div>
</div><!-- fragment --></dd></dl>
</li>
<li>Define the RTOS memory parameters and event bits for the mouse and keyboard HID events. <div class="fragment"><div class="line"><span class="preprocessor">#define USB_MAIN_TASK_MEMORY_REQ               (500U)</span></div>
<div class="line"><span class="preprocessor">#define USB_ISR_TASK_MEMORY_REQ                (500U)</span></div>
<div class="line"><span class="preprocessor">#define PRINT_TASK_MEMORY_REQ                  (500U)</span></div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="comment">/* Event bits for HID events */</span></div>
<div class="line"><span class="preprocessor">#define USB_TRIGGER_MOUSE_MESSAGE              (0x1U)</span></div>
<div class="line"><span class="preprocessor">#define USB_TRIGGER_KEYBOARD_MESSAGE           (0x2U)</span></div>
</div><!-- fragment --></li>
<li>Add a keyboard code array to connect to the keyboard: <div class="fragment"><div class="line"><span class="comment">/* Keyboard code array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* key_string[] =</div>
<div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;Reserved/(no event indicated)&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ErrorRollOver            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key POSTFail                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ErrorUndefined           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key a/A                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key b/B                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key c/C                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key d/D                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key e/E                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key f/F                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key g/G                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key h/H                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key i/I                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key j/J                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key k/K                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key l/L                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key m/M                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key n/N                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key o/O                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key p/P                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key q/Q                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key r/R                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key s/S                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key t/T                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key u/U                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key v/V                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key w/W                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key x/X                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key y/Y                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key z/Z                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 1/!                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 2/@                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 3/#                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 4/$                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 5/%                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 6/^                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 7/&amp;                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 8/*                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 9/(                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key 0/)                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Return (ENTER)           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ESCAPE                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key DELETE(Backspace)        &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Tab                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Spacebar                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key -/(underscore)           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key =/+                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key [/{                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ]/}                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key \\/|                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Non-US #/~               &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ;/:                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Apostrophe/Quotation mark&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key GraveAccent/Tilde        &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key,/&lt;                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ./&gt;                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key //?                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Caps Lock                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F1                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F2                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F3                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F4                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F5                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F6                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F7                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F8                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F9                       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F10                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F11                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F12                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key PrintScreen              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Scroll Lock              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Pause                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Insert                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Home                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key PageUp                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Delete Forward           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key End                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key PageDown                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key RightArrow               &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LeftArrow                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key DownArrow                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key UpArrow                  &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad NumLock/Clear         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad /                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad *                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad -                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad +                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad ENTER                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 1/End                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 2/Down Arrow          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 3/PageDn              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 4/Left Arrow          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 5                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 6/Right Arrow         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 7/Home                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 8/Up Arrow            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 9/PageUp              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 0/Insert              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad ./Delete              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Non-US \\/|              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Application              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Power                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad =                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F13                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F14                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F15                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F16                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F17                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F18                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F19                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F20                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F21                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F22                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F23                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key F24                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Execute                  &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Help                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Menu                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Select                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Stop                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Again                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Undo                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Cut                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Copy                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Paste                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Find                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Mute                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Volume Up                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Volume Down              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Locking CapsLock         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Locking NumLock          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Locking ScrollLock       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Comma                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Equal Sign            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International1           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International2           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International3           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International4           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International5           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International6           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International7           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International8           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key International9           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG1                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG2                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG3                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG4                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG5                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG6                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG7                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG8                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LANG9                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Alternate Erase          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key SysReq/Attention         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Cancel                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Clear                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Prior                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Return                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Separator                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Out                      &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Oper                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Clear/Again              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key CrSel/Props              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key ExSel                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 00                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad 000                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Thousands Separator          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Decimal Separator            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Currency Unit                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Currency Sub-unit            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad (                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad )                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad {                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad }                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Tab                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Backspace             &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad A                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad B                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad C                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad D                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad E                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad F                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad XOR                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad ^                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad %                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad &lt;                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad &gt;                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad &amp;                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad &amp;&amp;                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad |                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad ||                    &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad :                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad #                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Space                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad @                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad !                     &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Store          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Recall         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Clear          &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Add            &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Subtract       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Multiply       &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Memory Divide         &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad +/-                   &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Clear                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Clear Entry           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Binary                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Octal                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Decimal               &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Keypad Hexadecimal           &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LeftControl              &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LeftShift                &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key LeftAlt                  &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Left GUI                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key RightControl             &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key RightShift               &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key RightAlt                 &quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Key Right GUI                &quot;</span></div>
<div class="line">};</div>
</div><!-- fragment --> Add the mouse code to connect to the mouse: <div class="fragment"><div class="line"><span class="comment">/* Mouse code array */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span>* btnState_string[] =</div>
<div class="line">{</div>
<div class="line">    <span class="stringliteral">&quot;No click&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Left Button click&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Right Button click&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;Reserved/(no event indicated)&quot;</span>,</div>
<div class="line">    <span class="stringliteral">&quot;While Button click&quot;</span></div>
<div class="line">};</div>
</div><!-- fragment --></li>
<li>Create a structure prototype for tracking the status of keyboard and mouse events. <div class="fragment"><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct </span>usb_hid_status</div>
<div class="line">{</div>
<div class="line">    USBH_HID_MOUSE_DATA mouse_data;</div>
<div class="line">    USBH_HID_KEYBOARD_DATA keyboard_data;</div>
<div class="line">} usb_hid_status_t;</div>
</div><!-- fragment --></li>
<li>Declare the emUSB-Host HID global variables <div class="fragment"><div class="line"><span class="comment">/***************************************</span></div>
<div class="line"><span class="comment"> *          Global Variables</span></div>
<div class="line"><span class="comment"> ****************************************/</span></div>
<div class="line"><span class="keyword">static</span> USBH_NOTIFICATION_HOOK usbh_hid_notification;</div>
<div class="line"><span class="keyword">static</span> uint32_t usbh_not_used_context;</div>
<div class="line"><span class="comment">/* Declare a variable to hold the created event group. */</span></div>
<div class="line"><span class="keyword">static</span> EventGroupHandle_t hid_event;</div>
<div class="line"><span class="comment">/* The custom variable to save the status of events */</span></div>
<div class="line"><span class="keyword">static</span> usb_hid_status_t usb_hid_status;</div>
</div><!-- fragment --></li>
<li>Add functions for two mandatory tasks for the emUSB-Host functionality: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: usbh_task_free_rtos</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">* Summary:</span></div>
<div class="line"><span class="comment">* USBH_Task calling.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* \param arg  is not used in this function but required by FreeRTOS.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbh_task_free_rtos(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    (void)arg;</div>
<div class="line"> </div>
<div class="line">    USBH_Task();</div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        USBH_Logf_Application(<span class="stringliteral">&quot;Error: USBH_Task() end execution\n\r&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: usbh_isr_task_free_rtos</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* USBH_ISRTask calling.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* \param arg  is not used in this function but required by FreeRTOS.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> usbh_isr_task_free_rtos(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    (void)arg;</div>
<div class="line"> </div>
<div class="line">    USBH_ISRTask();</div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        USBH_Logf_Application(<span class="stringliteral">&quot;Error: USBH_ISRTask() end execution\n\r&quot;</span>);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Create a callback function for the device Add/Remove notification: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: new_device_notify</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Callback function implementation. Informs when a device is added or removed.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> new_device_notify(<span class="keywordtype">void</span>* pContext, U8 DevIndex, USBH_DEVICE_EVENT Event)</div>
<div class="line">{</div>
<div class="line">    (void)pContext;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">switch</span> (Event)</div>
<div class="line">    {</div>
<div class="line">    <span class="keywordflow">case</span> USBH_DEVICE_EVENT_ADD:</div>
<div class="line">        USBH_Logf_Application(<span class="stringliteral">&quot;Device added [%d]&quot;</span>, DevIndex);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">case</span> USBH_DEVICE_EVENT_REMOVE:</div>
<div class="line">        USBH_Logf_Application(<span class="stringliteral">&quot;Device removed [%d]&quot;</span>, DevIndex);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">default</span>:</div>
<div class="line">        USBH_Logf_Application(<span class="stringliteral">&quot;Invalid event [%d]&quot;</span>, DevIndex);</div>
<div class="line">        <span class="keywordflow">break</span>;</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Add callback functions for tracking the status of mouse and keyboard events: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: mouse_event</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Callback function implementation. Saves the statuses of mouse events.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> mouse_event(USBH_HID_MOUSE_DATA* pMouseData)</div>
<div class="line">{</div>
<div class="line">    usb_hid_status.mouse_data.xChange = pMouseData-&gt;xChange;</div>
<div class="line">    usb_hid_status.mouse_data.yChange = pMouseData-&gt;yChange;</div>
<div class="line">    usb_hid_status.mouse_data.WheelChange = pMouseData-&gt;WheelChange;</div>
<div class="line">    usb_hid_status.mouse_data.ButtonState = pMouseData-&gt;ButtonState;</div>
<div class="line">    usb_hid_status.mouse_data.InterfaceID = pMouseData-&gt;InterfaceID;</div>
<div class="line"> </div>
<div class="line">    (void)xEventGroupSetBits(hid_event, USB_TRIGGER_MOUSE_MESSAGE);</div>
<div class="line">}</div>
</div><!-- fragment --> <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: keyword_event</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Callback function implementation. Saves the statuses of mouse events. </span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> keyword_event(USBH_HID_KEYBOARD_DATA* pKeyData)</div>
<div class="line">{</div>
<div class="line">    usb_hid_status.keyboard_data.Code = pKeyData-&gt;Code;</div>
<div class="line">    usb_hid_status.keyboard_data.Value = pKeyData-&gt;Value;</div>
<div class="line">    usb_hid_status.keyboard_data.InterfaceID = pKeyData-&gt;InterfaceID;</div>
<div class="line"> </div>
<div class="line">    (void)xEventGroupSetBits(hid_event, USB_TRIGGER_KEYBOARD_MESSAGE);</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Create a function for printing mouse and keyboard events tasks: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: print_message</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Prints a message when a mouse or keyboard event happens.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* \param arg  is not used in this function but required by FreeRTOS.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> print_message(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    (void)arg;</div>
<div class="line">    EventBits_t uxBits;</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        <span class="comment">/* Gets the event group value */</span></div>
<div class="line">        uxBits = xEventGroupWaitBits(hid_event,</div>
<div class="line">            USB_TRIGGER_MOUSE_MESSAGE | USB_TRIGGER_KEYBOARD_MESSAGE, <span class="keyword">true</span>,</div>
<div class="line">            <span class="keyword">false</span>, portMAX_DELAY);</div>
<div class="line"> </div>
<div class="line">        <span class="keywordflow">if</span> ((uxBits &amp; USB_TRIGGER_MOUSE_MESSAGE) == USB_TRIGGER_MOUSE_MESSAGE)</div>
<div class="line">        {</div>
<div class="line">            USBH_Logf_Application(<span class="stringliteral">&quot;Mouse event:\n\r&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Prints mouse data */</span></div>
<div class="line">            USBH_Logf_Application(</div>
<div class="line">                <span class="stringliteral">&quot;X change - %d\n\rY change - %d\n\rWheel change - %d\n\rButton state - %d\n\rInterface ID - %d&quot;</span>,</div>
<div class="line">                usb_hid_status.mouse_data.xChange,</div>
<div class="line">                usb_hid_status.mouse_data.yChange,</div>
<div class="line">                usb_hid_status.mouse_data.WheelChange,</div>
<div class="line">                usb_hid_status.mouse_data.ButtonState,</div>
<div class="line">                usb_hid_status.mouse_data.InterfaceID);</div>
<div class="line">            </div>
<div class="line">            <span class="comment">/* Prints mouse buttons state */</span></div>
<div class="line">            USBH_Logf_Application(<span class="stringliteral">&quot;The button - %s&quot;</span>, btnState_string[usb_hid_status.mouse_data.ButtonState]);</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((uxBits &amp; USB_TRIGGER_KEYBOARD_MESSAGE) == USB_TRIGGER_KEYBOARD_MESSAGE)</div>
<div class="line">        {</div>
<div class="line">            USBH_Logf_Application(<span class="stringliteral">&quot;Keyboard event:\n\r&quot;</span>);</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Prints keyboard data */</span></div>
<div class="line">            USBH_Logf_Application(<span class="stringliteral">&quot;Code -- %d, Value - %d, Interface ID - %d&quot;</span>,</div>
<div class="line">                usb_hid_status.keyboard_data.Code,</div>
<div class="line">                usb_hid_status.keyboard_data.Value,</div>
<div class="line">                usb_hid_status.keyboard_data.InterfaceID);</div>
<div class="line"> </div>
<div class="line">            <span class="keywordflow">if</span> (usb_hid_status.keyboard_data.Code &gt; <span class="keyword">sizeof</span>(key_string) / <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>*))</div>
<div class="line">            {</div>
<div class="line">                USBH_Logf_Application(<span class="stringliteral">&quot;The key - Invalid code&quot;</span>);</div>
<div class="line">            }</div>
<div class="line">            <span class="keywordflow">else</span></div>
<div class="line">            {</div>
<div class="line">                <span class="comment">/* Prints the character of pressed key */</span></div>
<div class="line">                USBH_Logf_Application(<span class="stringliteral">&quot;The key - %s&quot;</span>, key_string[usb_hid_status.keyboard_data.Code]);</div>
<div class="line">            }</div>
<div class="line">        }</div>
<div class="line">        <span class="keywordflow">else</span></div>
<div class="line">        {</div>
<div class="line">            <span class="comment">/* A timeout occurs */</span></div>
<div class="line">        }</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Create a main_task() function: <div class="fragment"><div class="line"><span class="comment">/*******************************************************************************</span></div>
<div class="line"><span class="comment">* Function Name: main_task</span></div>
<div class="line"><span class="comment">********************************************************************************</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* Initializes the emUSB-Host stack, registers all necessary tasks.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">* \param arg  is not used in this function but required by FreeRTOS.</span></div>
<div class="line"><span class="comment">*</span></div>
<div class="line"><span class="comment">*******************************************************************************/</span></div>
<div class="line"><span class="keywordtype">void</span> main_task(<span class="keywordtype">void</span>* arg)</div>
<div class="line">{</div>
<div class="line">    (void)arg;</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initializes the USBH stack */</span></div>
<div class="line">    USBH_Init();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Creates the two tasks mandatory for USBH operation */</span></div>
<div class="line">    <span class="comment">/* Creates a task for USBH_ISR() function */</span></div>
<div class="line">     xTaskCreate(usbh_isr_task_free_rtos,</div>
<div class="line">         <span class="stringliteral">&quot;usbh_isr_task_free_rtos&quot;</span>,</div>
<div class="line">         USB_ISR_TASK_MEMORY_REQ,</div>
<div class="line">         NULL,</div>
<div class="line">         configMAX_PRIORITIES - 1,</div>
<div class="line">         NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Creates a task for USBH_Task() function */</span></div>
<div class="line">    xTaskCreate(usbh_task_free_rtos,</div>
<div class="line">        <span class="stringliteral">&quot;usbh_task_free_rtos&quot;</span>,</div>
<div class="line">        USB_MAIN_TASK_MEMORY_REQ,</div>
<div class="line">        NULL,</div>
<div class="line">        configMAX_PRIORITIES - 2,</div>
<div class="line">        NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Creates an additional task for printing message */</span></div>
<div class="line">    xTaskCreate(print_message,</div>
<div class="line">        <span class="stringliteral">&quot;print_message&quot;</span>,</div>
<div class="line">        PRINT_TASK_MEMORY_REQ,</div>
<div class="line">        NULL,</div>
<div class="line">        configMAX_PRIORITIES - 3,</div>
<div class="line">        NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Creates an event group for printing message */</span></div>
<div class="line">    hid_event = xEventGroupCreate();</div>
<div class="line">    <span class="comment">/* Check if event is created */</span></div>
<div class="line">    CY_ASSERT(hid_event != NULL);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Initializes the HID classes */</span></div>
<div class="line">    USBH_HID_Init();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Add callback functions for</span></div>
<div class="line"><span class="comment">     * - The HID devices are connected event</span></div>
<div class="line"><span class="comment">     * - The mouse state change event</span></div>
<div class="line"><span class="comment">     * - The keyboard state change event</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    <span class="comment">/* Adds callback function for HID devices are connected event */</span></div>
<div class="line">    USBH_HID_AddNotification(&amp;usbh_hid_notification,</div>
<div class="line">        new_device_notify,</div>
<div class="line">        (<span class="keywordtype">void</span>*)&amp;usbh_not_used_context);</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Adds callback function for mouse state change event */</span></div>
<div class="line">    USBH_HID_SetOnMouseStateChange(mouse_event);</div>
<div class="line">    <span class="comment">/* Adds callback function for keyboard state change event */</span></div>
<div class="line">    USBH_HID_SetOnKeyboardStateChange(keyword_event);</div>
<div class="line"> </div>
<div class="line">    <span class="keywordflow">for</span> (;;)</div>
<div class="line">    {</div>
<div class="line">        cy_rtos_delay_milliseconds((cy_time_t)1000U);</div>
<div class="line">    }</div>
<div class="line">}</div>
</div><!-- fragment --></li>
<li>Initialize retarget-io in main() to use the debug UART port: <dl class="section note"><dt>Note</dt><dd>If you are working with PSoC 6 boards, use the following code to configure retarget_io: <div class="fragment"><div class="line">    cy_retarget_io_init(CYBSP_DEBUG_UART_TX, CYBSP_DEBUG_UART_RX, CY_RETARGET_IO_BAUDRATE);</div>
</div><!-- fragment --> </dd>
<dd>
If you are working with XMC boards, use the following code to configure retarget_io: <div class="fragment"><div class="line">    cy_retarget_io_init(CYBSP_DEBUG_UART_HW);</div>
</div><!-- fragment --></dd></dl>
</li>
<li>Create a FreeRTOS task of the main_task() function into main(): <div class="fragment"><div class="line">    <span class="comment">/* Creates a FreeRTOS task of the main_task() function */</span></div>
<div class="line">    xTaskCreate(main_task, <span class="stringliteral">&quot;main_task&quot;</span>, 500U, NULL, configMAX_PRIORITIES - 1, NULL);</div>
<div class="line">    vTaskStartScheduler();</div>
</div><!-- fragment --></li>
</ol>
<h2><a class="anchor" id="subsection_qsg_step5"></a>
STEP 4: Check the emUSB-Host workability.</h2>
<ol type="1">
<li>Build and program your project.</li>
<li>Open the terminal and set baud rate 115200.</li>
<li>Connect the mouse or keyboard to the USB-Host connector of the board and observe log-messages of the HID device status. <div class="image">
<img src="emusb_terminal_log.png" alt=""/>
</div>
</li>
</ol>
<h1><a class="anchor" id="section_emusb_host_config_cons"></a>
Configuration Considerations</h1>
<p >This section explains the details of the emUSB-Host configuration.</p>
<h2><a class="anchor" id="section_emusb_host_hw_dep_conf"></a>
Hardware-dependent Configuration</h2>
<p >The hardware resources (Pins, clocks, interrupts) required for USB must be configured before the start of USB operation before calling USBH_Init() or in USBH_X_Config(). USB pins (D+ and D-) and USB clocks can be configured by a personality in the Device Configurator or by PDL/HAL drivers. Interrupts must be configured in the USBH_X_Config() function.</p>
<p >Also, register callback function by USBH_SetOnSetPortPower() to control enabling/disabling power to connected USB Devices by VBUS line.</p>
<p >The implementation template of USBH_X_Config() is provided for each device category in the Config directory under COMPONENT_CATx. This template is automatically copied into your project when middleware is added to project. This template does not include the configuration of clock and pins required for USB operation.</p>
<p >The template file define USBH_ALLOC_SIZE macro for the size of the memory pool. The size of memory is selected to satisfy RAM usage of Driver and a few connected devices, to provide the best experience for running code examples and evaluating the emUSB-Host software for the widest range of boards. Update this value with the optimal memory pool size (strongly recommended) for the application to find the balance between the memory consumption and features support. For details on selecting the optimal memory pool size, refer to the <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a> Memory pools chapter.</p>
<dl class="section warning"><dt>Warning</dt><dd>The template file also configures the pin responsible for enabling/disabling power to connected USB devices by VBUS line. The default value of the pin number is selected only for the CY8CKIT-062-WIFI-BT kit and must be modified for other boards.</dd></dl>
<p>For details on Hardware Dependent Configuration, refer to the - <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a>.</p>
<h3><a class="anchor" id="section_emusb_host_hw_dep_conf_pins"></a>
USB Pins Configuration</h3>
<p >The D+ and D- pins must be configured for USB operation. The emUSB-Host/Device personality in the Device Configurator allows for easy configuration of the pins. Otherwise, the pins can be configured manually by PDL APIs.</p>
<p ><b> CAT1A Devices Family </b></p>
<p >The following snippet initializes GPIO pins for USB operation by <a href="https://github.com/Infineon/mtb-pdl-cat1"><b>mtb-pdl-cat1 APIs</b></a>.</p>
<div class="fragment"><div class="line">    Cy_GPIO_Pin_FastInit(USBDP_PORT, USBDP_PIN, CY_GPIO_DM_ANALOG, 0U, USBDP_GPIO);</div>
<div class="line">    Cy_GPIO_Pin_FastInit(USBDM_PORT, USBDM_PIN, CY_GPIO_DM_ANALOG, 0U, USBDM_GPIO);</div>
</div><!-- fragment --><h3><a class="anchor" id="section_emusb_host_hw_dep_conf_clock"></a>
USB Clock Configuration</h3>
<p >The USB 2.0 specification defines the required bit rate accuracy for the USB Host in section 7.1.11. Ensure that the clock sources for USB meet the requirements.</p>
<p >The emUSB-Host/Device personality in the Device Configurator allows for easy configuration of the clocks for USB operation and also check if the clocks meet the requirements. Otherwise, the clocks can be configured manually by PDL/HAL APIs.</p>
<p ><b> CAT1A Devices Family</b></p>
<p >The USB Host requires one clock for operation:</p><ul>
<li>Clock the main clock at 48 MHz. Typically, the main clock is CLK_HF3 output signal, but refer to the device datasheet to identify the clock source for USB for a specific device.</li>
</ul>
<h3><a class="anchor" id="section_emusb_host_hw_dep_conf_int"></a>
USB Interrupt Configuration</h3>
<p >The interrupt is mandatory for the emUSB-Host Middleware operation. The interrupt priority selection is a part of Application level - the interrupt priority selected in the template files is not suitable for real project. For USB recommended setting the interrupt priority as high as possible.</p>
<p ><b> CAT1A Devices Family</b></p>
<p >emUSB-Host uses only one interrupt source from the three available in the IP USB block - usb_interrupt_med_IRQn. The emUSB-Host code can be executed on CM4 and CM0+ cores. For CM0+, the interrupt source of the USB IP block can be connected to one of CM0+ IRQs. Refer to the device datasheet and <a href="https://infineon.github.io/mtb-pdl-cat1/pdl_api_reference_manual/html/group__group__sysint.html"><b>SysInt (System Interrupt) Driver documentation</b></a> to find the available IRQs for CM0+.</p>
<p >The following code snippet shows the interrupt configuration for both CM4 and CM0+ cores.</p>
<dl class="section note"><dt>Note</dt><dd>The number of CM0+ interrupt vectors is different for different devices, so, this code snippet may not be suitable for all devices.</dd></dl>
<div class="fragment"><div class="line"><span class="comment">/* Define the interrupt source */</span></div>
<div class="line"><span class="preprocessor">#if (COMPONENT_CM0P)</span></div>
<div class="line"><span class="comment">/* The number of CM0+ interrupt vectors is different for different devices,</span></div>
<div class="line"><span class="comment"> * so, change the following macro for your selected device.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define USBH_INTERRUPT_NUM                      (NvicMux7_IRQn)</span></div>
<div class="line"><span class="preprocessor">#else</span></div>
<div class="line"><span class="preprocessor">#define USBH_INTERRUPT_NUM                      (usb_interrupt_med_IRQn)</span></div>
<div class="line"><span class="preprocessor">#endif </span><span class="comment">/* #if (COMPONENT_CM0P) */</span><span class="preprocessor"></span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Define the interrupt priority */</span></div>
<div class="line"><span class="preprocessor">#define USBH_ISR_PRIO                           (3U)</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* USB Interrupt handler */</span></div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> isr(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    USBH_ServiceISR(0);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keyword">static</span> <span class="keywordtype">void</span> config_interrupt_cat1a(<span class="keywordtype">void</span>)</div>
<div class="line">{</div>
<div class="line">    <span class="comment">/* Install the interrupt service routine */</span></div>
<div class="line">    cy_rslt_t result;</div>
<div class="line">    result = cyhal_system_set_isr(USBH_INTERRUPT_NUM, usb_interrupt_med_IRQn, USBH_ISR_PRIO, isr);</div>
<div class="line">    CY_ASSERT(CY_RSLT_SUCCESS == result);</div>
<div class="line">    (void) result; <span class="comment">/* To avoid the compiler warning in Release mode */</span></div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* Enable USB interrupt */</span></div>
<div class="line">    NVIC_EnableIRQ(USBH_INTERRUPT_NUM);</div>
<div class="line">}</div>
</div><!-- fragment --><h2><a class="anchor" id="section_emusb_host_debug_mes_out"></a>
Debug Message Output</h2>
<p >The debug builds of emUSB-Host allow using the debug message outputs. The template implementation of the message output functions is in export/Config/usbh_config_io.c file. This file is automatically copied into the ModusToolbox project when emUSB-Device middleware is added for the first time by the Library manager. Otherwise, copy this file manually. By default, <a href="https://github.com/Infineon/retarget-io"><b>retarget-io</b></a> is used for the message output, but message outputs can be redefined to any suitable output way. To disable the default message outputs, set USBH_DISABLE_STANDARD_OUTPUT=1 in the DEFINES variable in the application project Makefile. To provide a custom output method in addition to setting a variable add corresponding API under the #if (USBH_DISABLE_STANDARD_OUTPUT == 1U) condition inside the _puts() function.</p>
<p >For details on Hardware Debug Message Output, refer to the - <a href="./../UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a> Debugging chapter.</p>
<dl class="section note"><dt>Note</dt><dd>The retarget-io Middleware must be configured outside of the emUSB-Host Middleware for the message output. Refer to the <a href="https://github.com/Infineon/retarget-io#quick-start"><b>retarget-io Quick Start</b></a>.</dd></dl>
<h2><a class="anchor" id="section_emusb_host_low_power"></a>
Low Power Support</h2>
<p >Typically, RTOS goes to Idle state when no active tasks remain active. Often, the transition into Idle state is accompanied by entering the microcontroller in one of low-power modes (Depends on RTOS configuration). If the USB IP block does not support operation in some of the low-power modes, the emUSB-Host stack must be shut down by the USBH_Exit() function before entering this mode, and after exiting, emUSB-Host must be completely reinitialized by the application.</p>
<p ><b>Supported power modes by the Device family</b></p>
<table class="doxtable">
<tr>
<th>Device family</th><th>IP block power modes support </th></tr>
<tr>
<td>CAT1A </td><td>Active and Sleep  </td></tr>
</table>
<p ><b> CAT1A Devices </b> The USB IP block operates in Active and Sleep modes without any limitations, but in Deep Sleep, the USB IP block is disabled. emUSB-Host does not support any operations in low-power modes, in which the USB IP block is disabled. Also, emUSB-Host does not support the preparing and restoring before/after low-power modes, in which the USB IP block is disabled. As a result, if the microcontroller goes into Deep Sleep, emUSB-Host must be shut down by the USBH_Exit() function before entering this mode, and after exiting, emUSB-Host must be reinitialized.</p>
<p ><b>The Suspended/Resume condition generation from emUSB-Host</b></p>
<p >emUSB-Host can generate the Suspend/Resume condition for any connected device (directly or through the HUB). For more details, refer to the <a href="./../../Doc/UM10001_emUSBH.pdf"><b>SEGGER emUSB-Host User Guide &amp; Reference Manual</b></a> by keywords <em>Suspend</em> or <em>Resume</em>.</p>
<h2><a class="anchor" id="section_emusb_host_pick_lib"></a>
Picking an emUSB-Host Library Variant</h2>
<p >The Middleware provides emUSB-Host as pre-build libraries. The pre-build libraries are selected automatically based on configurations of Makefile configurations. The table below shows the availability of the configuration options.</p>
<table class="doxtable">
<tr>
<th>Configuration</th><th>Options</th><th>Make Variable </th></tr>
<tr>
<td>Device family </td><td>CAT1A </td><td>COMPONENTS  </td></tr>
<tr>
<td>Build configuration </td><td>Debug, Release </td><td>CONFIG  </td></tr>
<tr>
<td>Core </td><td><ul>
<li>CM0P, CM4 for CAT1A;  </li>
</ul>
</td><td>CORE  </td></tr>
<tr>
<td>Floating point </td><td>hardfp, softfp </td><td>VFP_SELECT  </td></tr>
<tr>
<td>Toolchain </td><td>GCC_ARM, IAR, ARM </td><td>TOOLCHAIN  </td></tr>
</table>
<dl class="section note"><dt>Note</dt><dd>Typically, the device family and core are selected in BSP Makefile.</dd>
<dd>
CM0P supports only softfp.</dd></dl>
<p>The header file USBH_ConfDefaults.h under the USBH directory contains common configuration used in the libraries generation. Similarly, USBH_Conf.h under each COMPONENT_&lt;Device family&gt;/CONFIG_&lt; Build configuration&gt; directory contains configuration specific to the set of library variants.</p>
<h2><a class="anchor" id="section_emusb_host_use_in_rtos"></a>
Using emUSB-Host in an RTOS Environment</h2>
<p >The emUSB-Host has been already implemented the Target OS Interface. The OS layer uses the <a href="https://github.com/Infineon/abstraction-rtos"><b>abstraction-rtos</b></a> library, so, emUSB-Device can be used with RTOSes supported by the <a href="https://github.com/Infineon/abstraction-rtos"><b>abstraction-rtos</b></a> library.</p>
<p >USBH_OS_DisableInterrupt() and USBH_OS_EnableInterrupt() are the weak functions. The weak implementation of USBH_OS_DisableInterrupt() and USBH_OS_EnableInterrupt() uses the enter/exit critical section functions from mtb-hal-cat1 library. The implementation of USBH_OS_DisableInterrupt() and USBH_OS_EnableInterrupt() may by overridden in the user's code by providing a function with the same name. This allows you to provide a custom implementation that can better satisfy application requirements, for example doesn't disable all interrupts.</p>
<dl class="section note"><dt>Note</dt><dd>The USBH_OS_DisableInterrupt() and USBH_OS_EnableInterrupt() functions must always disable the USB interrupts and task switching.</dd>
<dd>
The emUSB-Host operation requires the RTOS.</dd></dl>
<h1><a class="anchor" id="section_emusb_host_package_str"></a>
emUSB-Host Package Structure</h1>
<p >The Middleware structure:</p><ul>
<li><b>export/Config:</b> Contains sample configuration files for hardware-specific configuration.</li>
<li><b>OS:</b> Contains the OS layer implementation.</li>
<li><b>USBH:</b> Contains a set of pre-build emUSB-Host libraries for different configurations of user applications (Device family, Build configuration, Core, Floating point, Toolchain), and a set of header files.</li>
<li><b>docs:</b> Contains the API Reference Guide, SEGGER-provided emUSB-Host User Guide &amp; Reference Manual and other supporting documentation.</li>
</ul>
<h1><a class="anchor" id="section_emusb_host_changelog"></a>
Changelog</h1>
<dl class="section note"><dt>Note</dt><dd>The emUSB-Host Middleware by Infineon and emUSB-Host stack by Segger have different versions.</dd></dl>
<table class="doxtable">
<tr>
<th>Version</th><th>Changes</th><th>Reason for Change </th></tr>
<tr>
<td rowspan="5">1.1.0 </td><td>Updated the emUSB-Host stack to 2.36.1 </td><td>New version is available  </td></tr>
<tr>
<td>The OS layer uses abstraction-rtos APIs instead of FreeRTOS. This means that emUSB-Device can be used with RTOS supported by abstraction-rtos included FreeRTOS  </td><td>Extend the number of supported RTOS  </td></tr>
<tr>
<td>Added the functionality in the usbh_config.c file to control enabling/disabling power on VBUS line </td><td>The changes allow to support the correct reinitialization of emUSB-Host  </td></tr>
<tr>
<td>Updated the implementation of Debug Message Output. The usbh_config_io.c file became more friendly for updating and a USBH_DISABLE_STANDARD_OUTPUT macro was added. For details, refer to <a class="el" href="index.html#section_emusb_host_debug_mes_out">Debug Message Output</a>  </td><td>Improved the usability of Debug Message Output  </td></tr>
<tr>
<td>Minor documentation updates </td><td></td></tr>
<tr>
<td>1.0.1 </td><td>Updating the LICENSE file </td><td></td></tr>
<tr>
<td>1.0.0 </td><td>Initial release of emUSB-Host stack 2.36.0 </td><td></td></tr>
</table>
</div></div><!-- PageDoc -->
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part
<div id="nav-path" class="navpath">
    <ul>
        <li class="footer">
            Generated for <b>emusb-host</b> by <b>Cypress Semiconductor Corporation</b>.
            All rights reserved.
        </li>
    </ul>
</div>
-->
</body>
</html>
